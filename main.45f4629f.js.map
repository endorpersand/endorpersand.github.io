{"mappings":"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","sources":["src/complexgrapher/worker/main.ts","node_modules/.pnpm/@parcel+runtime-js@2.6.2_@parcel+core@2.6.2/node_modules/@parcel/runtime-js/lib/runtime-f8ff6cd77dde705c.js","node_modules/.pnpm/@parcel+runtime-js@2.6.2_@parcel+core@2.6.2/node_modules/@parcel/runtime-js/lib/helpers/get-worker-url.js","node_modules/.pnpm/@parcel+runtime-js@2.6.2_@parcel+core@2.6.2/node_modules/@parcel/runtime-js/lib/helpers/bundle-url.js","node_modules/.pnpm/@parcel+transformer-js@2.6.2_@parcel+core@2.6.2/node_modules/@parcel/transformer-js/src/esmodule-helpers.js"],"sourcesContent":["import { MainIn, MainOut, LoaderIn, LoaderOut, CanvasData, PartialEvaluator, InitIn, InitOut } from \"../types\";\n\nconst CHUNK_SIZE = 50;\nconst N_WORKERS = 4;\n\nlet free: Worker[] = [];\n\ntype Ticket = [LoaderIn, Symbol, number];\n\n/**\n * Map that links a worker to the task they've been assigned\n */\nlet labor: Map<Worker, [Symbol, number]> = new Map();\n\n/**\n * The queue to pull work from\n */\nlet workQueue: Generator<Ticket>;\n\n/**\n * The current task to be working on\n */\nlet currentTask: Symbol;\n\nonmessage = async function (e: MessageEvent<InitIn | MainIn>) {\n    let data = e.data;\n\n    if (data.action === \"init\") {\n        await initLoaders();\n        self.postMessage({action: \"ready\"});\n    } else if (data.action === \"mainRequest\") {\n        let start = this.performance.now();\n        let {pev, cd} = data;\n\n        // on a request, start up the queue and assign work to all currently free workers\n        workQueue = queue(start, pev, cd);\n    \n        let fit = free[Symbol.iterator]();\n        for (let w of fit) {\n            let t = workQueue.next();\n    \n            if (!t.done) {\n                assignWorkToWorker(w, t.value);\n            } else {\n                break;\n            }\n        }\n        free = [...fit];\n    } else {\n        let _: never = data;\n        throw new Error(\"Unexpected request into main worker\");\n    }\n}\n\n/**\n * @returns a promise which resolves once all the chunkLoaders have been created and initialized\n */\nasync function initLoaders() {\n    if (free.length > 0) return;\n    \n    free = Array.from({length: N_WORKERS}, () => \n        new Worker(new URL(\"./chunkLoader\", import.meta.url), {type: \"module\"})\n    );\n\n    let promises = Array.from(free, w => \n        new Promise<Worker>(resolve => {\n            w.onmessage = function (e: MessageEvent<InitOut>) {\n                resolve(w);\n            }\n            w.postMessage({action: \"init\"});\n        })\n        .then(w => {\n            w.onmessage = function (e: MessageEvent<LoaderOut>) {\n                let out = e.data;\n        \n                let ticket = labor.get(w);\n                if (typeof ticket === \"undefined\") return; // worker wasn't working on a ticket\n\n                // If the current task is the currentTask, post up \"loadChunk\"\n                let [sym, start] = ticket;\n                if (currentTask == sym) {\n                    self.postMessage(out, [out.buf] as any);\n                }\n        \n                // If there's any more work left to do, take it.\n                // Otherwise, free the worker and post up \"done\"\n                let t = workQueue.next();\n                if (!t.done) {\n                    // reassign\n                    assignWorkToWorker(w, t.value);\n                } else {\n                    // no more work to do, free the worker\n                    freeWorker(w);\n        \n                    // if all chunks finished, send done\n                    if (typeof start !== \"undefined\" && labor.size == 0) {\n                        let done: MainOut = { action: \"done\", time: Math.trunc(performance.now() - start) };\n                        self.postMessage(done);\n                    }\n                }\n            }\n        \n            w.onerror = function (e) {\n                freeWorker(w);\n            }\n        })\n    );\n    \n    return await Promise.all(promises);\n}\n\n/**\n * Generator that breaks up the canvas into computable chunks, which can be sent to chunkLoaders to compute them\n * @param start Time queue started\n * @param pev Partial evaluator that needs to be evaluated\n * @param cd The dimension data of the canvas to chunk\n */\nfunction* queue(start: number, pev: PartialEvaluator, cd: CanvasData): Generator<Ticket> {\n    let {width, height} = cd;\n    currentTask = Symbol(\"task\");\n\n    for (let i = 0; i < width; i += CHUNK_SIZE) {\n        for (let j = 0; j < height; j += CHUNK_SIZE) {\n            let cw = clamp(0, CHUNK_SIZE, width - i);\n            let ch = clamp(0, CHUNK_SIZE, height - j);\n\n            yield [{\n                action: \"chunkRequest\",\n                pev, cd,\n                chunk: {\n                    width: cw, height: ch, offx: i, offy: j\n                }\n            }, currentTask, start];\n        }\n    }\n}\n\n/**\n * Designate a worker as free to work.\n * @param w Worker to mark as free.\n */\nfunction freeWorker(w: Worker) {\n    labor.delete(w);\n    free.push(w);\n}\n\n/**\n * Assign a worker a chunk to compute.\n * @param w Worker to designate.\n * @param param1 Ticket to work on.\n */\nfunction assignWorkToWorker(w: Worker, [job, sym, start]: Ticket) {\n    w.postMessage(job);\n    labor.set(w, [sym, start]);\n}\n\nfunction clamp(v: number, min: number, max: number) {\n    return Math.max(min, Math.min(v, max));\n}","let workerURL = require('./helpers/get-worker-url');\nlet bundleURL = require('./helpers/bundle-url');\nlet url = bundleURL.getBundleURL('gIi11') + \"chunkloader.966fd52a.js\";module.exports = workerURL(url, bundleURL.getOrigin(url), false);","\"use strict\";\n\nmodule.exports = function (workerUrl, origin, isESM) {\n  if (origin === self.location.origin) {\n    // If the worker bundle's url is on the same origin as the document,\n    // use the worker bundle's own url.\n    return workerUrl;\n  } else {\n    // Otherwise, create a blob URL which loads the worker bundle with `importScripts`.\n    var source = isESM ? 'import ' + JSON.stringify(workerUrl) + ';' : 'importScripts(' + JSON.stringify(workerUrl) + ');';\n    return URL.createObjectURL(new Blob([source], {\n      type: 'application/javascript'\n    }));\n  }\n};","\"use strict\";\n\nvar bundleURL = {};\n\nfunction getBundleURLCached(id) {\n  var value = bundleURL[id];\n\n  if (!value) {\n    value = getBundleURL();\n    bundleURL[id] = value;\n  }\n\n  return value;\n}\n\nfunction getBundleURL() {\n  try {\n    throw new Error();\n  } catch (err) {\n    var matches = ('' + err.stack).match(/(https?|file|ftp|(chrome|moz|safari-web)-extension):\\/\\/[^)\\n]+/g);\n\n    if (matches) {\n      // The first two stack frames will be this function and getBundleURLCached.\n      // Use the 3rd one, which will be a runtime in the original bundle.\n      return getBaseURL(matches[2]);\n    }\n  }\n\n  return '/';\n}\n\nfunction getBaseURL(url) {\n  return ('' + url).replace(/^((?:https?|file|ftp|(chrome|moz|safari-web)-extension):\\/\\/.+)\\/[^/]+$/, '$1') + '/';\n} // TODO: Replace uses with `new URL(url).origin` when ie11 is no longer supported.\n\n\nfunction getOrigin(url) {\n  var matches = ('' + url).match(/(https?|file|ftp|(chrome|moz|safari-web)-extension):\\/\\/[^/]+/);\n\n  if (!matches) {\n    throw new Error('Origin not found');\n  }\n\n  return matches[0];\n}\n\nexports.getBundleURL = getBundleURLCached;\nexports.getBaseURL = getBaseURL;\nexports.getOrigin = getOrigin;","exports.interopDefault = function (a) {\n  return a && a.__esModule ? a : {default: a};\n};\n\nexports.defineInteropFlag = function (a) {\n  Object.defineProperty(a, '__esModule', {value: true});\n};\n\nexports.exportAll = function (source, dest) {\n  Object.keys(source).forEach(function (key) {\n    if (key === 'default' || key === '__esModule' || dest.hasOwnProperty(key)) {\n      return;\n    }\n\n    Object.defineProperty(dest, key, {\n      enumerable: true,\n      get: function () {\n        return source[key];\n      },\n    });\n  });\n\n  return dest;\n};\n\nexports.export = function (dest, destName, get) {\n  Object.defineProperty(dest, destName, {\n    enumerable: true,\n    get: get,\n  });\n};\n"],"names":[],"version":3,"file":"main.45f4629f.js.map","sourceRoot":"/__parcel_source_root/"}